From 294deb379632d56bf2dc7dc27fa823bc84265c9b Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@st.com>
Date: Wed, 22 Nov 2017 18:20:19 +0100
Subject: [PATCH] mx6: solidrun: add support for hummingboard2 and SOM v1.5

Based on a similar patch available in the SolidRun u-boot repository.

Requires a kernel that includes the hummingboard2 device tree files.

Signed-off-by: Ricardo Salveti <ricardo.salveti@linaro.org>
Signed-off-by: Christophe Priouzeau <christophe.priouzeau@st.com>
---
 board/solidrun/mx6cuboxi/mx6cuboxi.c | 66 +++++++++++++++++++++++++++++++++---
 include/configs/mx6cuboxi.h          |  9 +++++
 2 files changed, 71 insertions(+), 4 deletions(-)

diff --git a/board/solidrun/mx6cuboxi/mx6cuboxi.c b/board/solidrun/mx6cuboxi/mx6cuboxi.c
index ee9e4f7..eb6d4e2 100644
--- a/board/solidrun/mx6cuboxi/mx6cuboxi.c
+++ b/board/solidrun/mx6cuboxi/mx6cuboxi.c
@@ -82,6 +82,7 @@ static iomux_v3_cfg_t const hb_cbi_sense[] = {
 	/* These pins are for sensing if it is a CuBox-i or a HummingBoard */
 	IOMUX_PADS(PAD_KEY_ROW1__GPIO4_IO09  | MUX_PAD_CTRL(UART_PAD_CTRL)),
 	IOMUX_PADS(PAD_EIM_DA4__GPIO3_IO04   | MUX_PAD_CTRL(UART_PAD_CTRL)),
+	IOMUX_PADS(PAD_SD4_DAT0__GPIO2_IO08  | MUX_PAD_CTRL(UART_PAD_CTRL)),
 };
 
 static iomux_v3_cfg_t const usb_pads[] = {
@@ -334,6 +335,55 @@ int board_init(void)
 	return ret;
 }
 
+enum {
+	CUBOXI = 0,
+	HUMMINGBOARD,
+	HUMMINGBOARD2,
+	HUMMINGBOARD2V15,
+};
+
+static int detect_board(void)
+{
+	int val1, val2, val3, val4, val5;
+
+	SETUP_IOMUX_PADS(hb_cbi_sense);
+
+	gpio_direction_input(IMX_GPIO_NR(4, 9));
+	gpio_direction_input(IMX_GPIO_NR(3, 4));
+	gpio_direction_input(IMX_GPIO_NR(2, 8));
+	gpio_direction_input(IMX_GPIO_NR(6, 0));
++	gpio_direction_input(IMX_GPIO_NR(6, 4));
+
+	val1 = gpio_get_value(IMX_GPIO_NR(4, 9));
+	val2 = gpio_get_value(IMX_GPIO_NR(3, 4));
+	val3 = gpio_get_value(IMX_GPIO_NR(2, 8));
+	val4 = gpio_get_value(IMX_GPIO_NR(6, 0));
+	val5 = gpio_get_value(IMX_GPIO_NR(6, 4));
+
+	/*
+	 * Machine selection -
+	 * Machine        val1, val2, val3
+	 * -------------------------------
+	 * HB2            x     x     0
+	 * HB rev 3.x     x     0     x
+	 * CBi            0     1     x
+	 * HB             1     1     x
+	 */
+
+	if (val3 == 0) {
+		if (1 == val4 && 0 == val5)
+			return HUMMINGBOARD2V15;
+		return HUMMINGBOARD2;
+	}
+	else if (val2 == 0)
+		return HUMMINGBOARD;
+	else if (val1 == 0)
+		return CUBOXI;
+	else
+		return HUMMINGBOARD;
+}
+
+
 static bool is_hummingboard(void)
 {
 	int val1, val2;
@@ -392,10 +442,14 @@ static bool is_hummingboard2(void)
 
 int checkboard(void)
 {
-	if (is_hummingboard2())
+	int board = detect_board();
+
+	if (board == HUMMINGBOARD2)
 		puts("Board: MX6 Hummingboard2\n");
-	else if (is_hummingboard())
+	else if (board == HUMMINGBOARD)
 		puts("Board: MX6 Hummingboard\n");
+	else if (board == HUMMINGBOARD2V15)
+		puts("Board: MX6 Hummingboard2 SOM v1.5\n");
 	else
 		puts("Board: MX6 Cubox-i\n");
 
@@ -405,10 +459,14 @@ int checkboard(void)
 int board_late_init(void)
 {
 #ifdef CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG
-	if (is_hummingboard2())
+	int board = detect_board();
+
+	if (board == HUMMINGBOARD2)
 		env_set("board_name", "HUMMINGBOARD2");
-	else if (is_hummingboard())
+	else if (board == HUMMINGBOARD)
 		env_set("board_name", "HUMMINGBOARD");
+	else if (board == HUMMINGBOARD2V15)
+		env_set("board_name", "HUMMINGBOARD2V15");
 	else
 		env_set("board_name", "CUBOXI");
 
diff --git a/include/configs/mx6cuboxi.h b/include/configs/mx6cuboxi.h
index 7fefe8e..354f846 100644
--- a/include/configs/mx6cuboxi.h
+++ b/include/configs/mx6cuboxi.h
@@ -55,6 +55,7 @@
 #define CONFIG_MXC_USB_PORTSC		(PORT_PTS_UTMI | PORT_PTS_PTW)
 #define CONFIG_MXC_USB_FLAGS		0
 #define CONFIG_USB_MAX_CONTROLLER_COUNT	2
+#if 0
 #define CONFIG_PREBOOT \
 	"if hdmidet; then " \
 		"usb start; "		       \
@@ -66,6 +67,12 @@
 		"setenv stdout serial; " \
 		"setenv stderr serial; " \
 	"fi;"
+#else
+#define CONFIG_PREBOOT \
+	"setenv stdin  serial; " \
+	"setenv stdout serial; " \
+	"setenv stderr serial; "
+#endif
 
 /* Command definition */
 
@@ -108,6 +115,8 @@
 	"findfdt="\
 		"if test $board_name = HUMMINGBOARD2 && test $board_rev = MX6Q ; then " \
 			"setenv fdtfile imx6q-hummingboard2.dtb; fi; " \
+		"if test $board_name = HUMMINGBOARD2V15 && test $board_rev = MX6Q ; then " \
+			"setenv fdtfile imx6q-hummingboard2-som-v15.dtb; fi; " \
 		"if test $board_name = HUMMINGBOARD2 && test $board_rev = MX6DL ; then " \
 			"setenv fdtfile imx6dl-hummingboard2.dtb; fi; " \
 		"if test $board_name = HUMMINGBOARD && test $board_rev = MX6Q ; then " \
-- 
2.7.4

